<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <marimo-mode data-mode='read' hidden></marimo-mode>
    <marimo-version data-version='0.13.11' hidden></marimo-version>
    <marimo-user-config data-config='{"completion": {"activate_on_typing": true, "copilot": false}, "display": {"code_editor_font_size": 14, "default_table_page_size": 10, "theme": "dark", "custom_css": [], "dataframes": "rich", "default_width": "medium", "cell_output": "below"}, "formatting": {"line_length": 79}, "keymap": {"preset": "default", "overrides": {}}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "reactive_tests": true, "on_cell_change": "autorun", "watcher_on_save": "lazy", "output_max_bytes": 8000000, "std_stream_max_bytes": 1000000, "default_sql_output": "auto"}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "package_management": {"manager": "pip"}, "server": {"browser": "default", "follow_symlink": false}, "language_servers": {"pylsp": {"enabled": true, "enable_mypy": true, "enable_ruff": true, "enable_flake8": false, "enable_pydocstyle": false, "enable_pylint": false, "enable_pyflakes": false}}, "snippets": {"custom_paths": [], "include_default_snippets": true}}' data-overrides='{}' hidden></marimo-user-config>
    <marimo-app-config data-config='{"width": "full", "app_title": "Compare quotation detection methods", "css_file": "highlight.css", "sql_output": "auto"}' hidden></marimo-app-config>
    <marimo-server-token data-token='123' hidden></marimo-server-token>
    <title>Compare quotation detection methods</title>
    <script type="module" crossorigin src="./assets/index-BR3wLmMq.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-CQvPIadz.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <style title='marimo-custom'>:root {
	/* define highlight colors here as CSS variables */

/* https://observablehq.com/@jotasolano/paul-tol-schemes */
/* qualitative vibrant
	["#EE7733","#0077BB","#33BBEE","#EE3377","#CC3311","#009988"] */
	--light-highlight-color1: #EE7733;
	--light-highlight-color2: #0077BB;
	--light-highlight-color3: #33BBEE;
	--light-highlight-color4: #EE3377;
	--light-highlight-color5: #CC3311;
	--light-highlight-color6: #009988;
	/* qualitative bright
["#4477AA","#EE6677","#228833","#CCBB44","#66CCEE","#AA3377"]  */
	--dark-highlight-color1: #4477AA;
	--dark-highlight-color2: #EE6677;
	--dark-highlight-color3: #228833;
	--dark-highlight-color4: #CCBB44;
	--dark-highlight-color5: #66CCEE;
	--dark-highlight-color6: #AA3377;
}

mark {
	/* override default styles for mark; remove highlight/color, add underline */
	background-color: transparent;
	color: currentColor;

	/* set separate styles so it is easier to override */
	text-decoration-line: underline;
	text-decoration-style: solid;
	text-decoration-color: light-dark(var(--light-highlight-color1), var(--dark-highlight-color1));
	text-decoration-thickness: 2px;
    text-underline-offset: 3px;
}


section.page {
	white-space: pre-line;
	position: relative;
}

section.page header {
	position: sticky;
	top: -1em;	  /* adjust for scrolling within marimo cell */
	padding-top: 1em;
	padding-bottom: 1em;
	border-bottom: 1px solid currentColor;
	background-color: var(--background);
}


p.info {
	font-size: smaller;
	position: absolute;
	top: 1em;
	right: 5px;
}

section header h1 {
	font-weight: bold;
}

dl dt {
	font-weight: bold;
	display: inline-block;
}
dl dt::after {
	content: ": ";
}

dl dd {
	display: inline-block;
	padding-left: 2px;
	padding-right: 1em;
}


.compare {
	position: relative;
}
.compare.multi > div, .compare.primary, .compare.secondary {
	/* this is useful but not being applied consistently; disable for now */
	white-space: pre-line;
}

.compare.multi > div:not(:first-child) {
	position: absolute;
	top: 0;
	left: 0;
}

/* for any div after the first, make the text transparent to avoid artifacts
 when text does not exactly align (although beware of texts that differ too much!) */
.compare.multi div:nth-child(n+2) {
	/* comment color and uncomment opacity to test */
	color: transparent;
/*	opacity: 0.2;*/
}

.highlight2 mark {
	text-decoration-color: light-dark(var(--light-highlight-color2), var(--dark-highlight-color2));
	text-decoration-style: wavy;
	text-decoration-thickness: 1px;	 /* 2px wavy looks too thick */
}

.highlight3 mark {
	text-decoration-color: light-dark(var(--light-highlight-color3), var(--dark-highlight-color3));
	text-decoration-style: dotted;
	text-decoration-thickness: 4px;	 /* 2px dotted is hard to see*/
    text-underline-offset: 4px;
}

.compare.multi div:nth-child(n+2) mark, .compare.secondary mark {
	/* use wavy underlines for secondary highlights;
	everything after the first div in a span-compare section, or secondary-span
	 */
	text-decoration-style: wavy;
    text-underline-offset: 5px;
	text-decoration-thickness: 1px;
	text-decoration-color: light-dark(var(--light-highlight-color2), var(--dark-highlight-color3));
}

.compare.multi  div:nth-child(3) mark {
	text-decoration-style: dotted;
	text-decoration-color: light-dark(var(--light-highlight-color3), var(--dark-highlight-color3));
}
.compare.multi  div:nth-child(4) mark {
	text-decoration-color: light-dark(var(--light-highlight-color4), var(--dark-highlight-color4));
}
.compare.multi  div:nth-child(5) mark {
	text-decoration-color: light-dark(var(--light-highlight-color5), var(--dark-highlight-color5));
}</style><marimo-code hidden="" data-show-code="false">import%20marimo%0A%0A__generated_with%20%3D%20%220.13.11%22%0Aapp%20%3D%20marimo.App(%0A%20%20%20%20width%3D%22full%22%2C%0A%20%20%20%20app_title%3D%22Compare%20quotation%20detection%20methods%22%2C%0A%20%20%20%20css_file%3D%22highlight.css%22%2C%0A)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20return%20(mo%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%20Quotation%20detection%20results%20%0A%0A%0A%20%20%20%20%5Bseq2seq-quotation-attribution%5D(https%3A%2F%2Fgithub.com%2Fuhh-lt%2Fseq2seq-quotation-attribution)%20is%20a%20software%20tool%20for%20%22Fine-grained%20quotation%20detection%20and%20attribution%20in%20German%20news%20articles%22%20by%20Fynn%20Petersen-Frey%20%26%20Chris%20Biemann%2C%20published%20at%20KONVENS%202024.%20Implementation%20based%20on%20%5BSeq2seqCoref%5D(https%3A%2F%2Fgithub.com%2FWenzhengZhang%2FSeq2seqCoref).%0A%0A%20%20%20%20We%20ran%20this%20tool%20on%20the%20text%20file%20**1896-97aCLEAN.txt**%3B%20this%20notebook%20shows%20some%20of%20the%20results%20alongside%20for%20pages%20with%20annotations.%20%0A%0A%20%20%20%20As%20an%20additional%20point%20of%20comparison%2C%20we%20also%20show%20results%20for%20a%20simple%20heuristic%20method%20based%20on%20quotation%20marks%20for%20the%20same%20pages.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20polars%20as%20pl%0A%20%20%20%20return%20(pl%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(r%22%22%22%20%22%22%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20pl)%3A%0A%20%20%20%20%23%20Load%20data%0A%20%20%20%20%23%0A%20%20%20%20%23%20Load%20seq2seq%20quotes%20output%2C%20and%20previously%20calculated%20offset%20adjustment%20to%20annotated%20file.%0A%0A%20%20%20%20%23%20public%20locaiton%20for%20compilation%20to%20wasm%0A%20%20%20%20seq2seq_quotes_file%20%3D%20mo.notebook_location()%20%2F%20%22public%22%20%2F%20%22seq2seq_quotes.csv%22%0A%0A%20%20%20%20quotes_df%20%3D%20pl.read_csv(str(seq2seq_quotes_file))%0A%0A%20%20%20%20input_offset_file%20%3D%20(%0A%20%20%20%20%20%20%20%20mo.notebook_location()%20%2F%20%22public%22%20%2F%20%22seq2seq_input_offsets.csv%22%0A%20%20%20%20)%0A%20%20%20%20input_offset_df%20%3D%20pl.read_csv(str(input_offset_file))%0A%0A%20%20%20%20%23%20join%20seq2seq%20quotes%20data%20with%20input%20file%20offsets%20so%20we%20can%20calculate%20offset%20in%20the%20annotated%20file%0A%20%20%20%20quotes_source_text%20%3D%20quotes_df.join(input_offset_df%2C%20on%3D%22file%22)%0A%20%20%20%20return%20quotes_df%2C%20quotes_source_text%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20quotes_source_text)%3A%0A%20%20%20%20%23%20adjust%20offsets%20to%20match%20annotated%20file%0A%20%20%20%20from%20intspan%20import%20intspan%0A%0A%0A%20%20%20%20%23%20use%20intspan%20to%20parse%20and%20adjust%20by%20file%20offset%20and%20then%20serialize%20back%20to%20a%20span%0A%20%20%20%20def%20adjust_span_offset(span%2C%20adjustment)%3A%0A%20%20%20%20%20%20%20%20span%20%3D%20intspan(%0A%20%20%20%20%20%20%20%20%20%20%20%20span.replace(%22%3B%22%2C%20%22%2C%22)%0A%20%20%20%20%20%20%20%20)%20%20%23%20replace%20%3B%20with%20%2C%20so%20intspan%20can%20parse%20ranges%0A%20%20%20%20%20%20%20%20%23%20adjust%20all%20values%0A%20%20%20%20%20%20%20%20adjusted_span%20%3D%20intspan(%5Bi%20%2B%20adjustment%20for%20i%20in%20list(span)%5D)%0A%20%20%20%20%20%20%20%20return%20str(adjusted_span)%0A%0A%0A%20%20%20%20%23%20use%20intspan%20to%20parse%20and%20get%20first%20offset%20value%0A%20%20%20%20def%20first_offset(span)%3A%0A%20%20%20%20%20%20%20%20return%20list(intspan(span))%5B0%5D%0A%0A%0A%20%20%20%20%23%20df.select(%5Bpl.struct(%5B%22ham%22%2C%20%22spam%22%2C%20%22foo%22%5D).apply(my_complicated_function)%5D)%0A%0A%20%20%20%20%23%20start%20with%20quote%20offsets%20and%20then%20figure%20out%20which%20others%20we%20need%0A%20%20%20%20adjusted_offsets%20%3D%20quotes_source_text.select(%0A%20%20%20%20%20%20%20%20pl.col(%22quote_offsets%22%2C%20%22file_offset%22)%0A%20%20%20%20).map_rows(%0A%20%20%20%20%20%20%20%20lambda%20row%3A%20adjust_span_offset(row%5B0%5D%2C%20row%5B1%5D)%2C%20return_dtype%3Dpl.String%0A%20%20%20%20)%0A%0A%20%20%20%20quotes_adjusted%20%3D%20quotes_source_text.with_columns(%0A%20%20%20%20%20%20%20%20quote_offsets_adjusted%3Dpl.Series(adjusted_offsets)%2C%0A%20%20%20%20%20%20%20%20quote_offset_start%3Dpl.Series(adjusted_offsets).map_elements(%0A%20%20%20%20%20%20%20%20%20%20%20%20first_offset%2C%20return_dtype%3Dpl.Int32%0A%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20)%0A%20%20%20%20return%20adjust_span_offset%2C%20intspan%2C%20quotes_adjusted%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20pl)%3A%0A%20%20%20%20%23%20load%20quote%20annotations%20test%20subset%0A%20%20%20%20%23%20-%20filter%20to%20the%20file%20we%20ran%20seq2seq%20on%0A%0A%20%20%20%20%23%20direct_quotes_subset_file%20%3D%20%22data%2Fdirect_quotes_subset.csv%22%0A%20%20%20%20direct_quotes_subset_file%20%3D%20(%0A%20%20%20%20%20%20%20%20mo.notebook_location()%20%2F%20%22public%22%20%2F%20%22direct_quotes_subset.csv%22%0A%20%20%20%20)%0A%0A%20%20%20%20quote_annotations%20%3D%20pl.read_csv(str(direct_quotes_subset_file)).filter(%0A%20%20%20%20%20%20%20%20pl.col(%22FILE%22).eq(%221896-97aCLEAN.txt%22)%0A%20%20%20%20)%0A%20%20%20%20return%20(quote_annotations%2C)%0A%0A%0A%40app.cell%0Adef%20_(pl%2C%20quote_annotations)%3A%0A%20%20%20%20%23%20get%20a%20unique%20list%20of%20pages%20from%20quote%20annotations%20(some%20pages%20have%20multiple%20quotes)%0A%20%20%20%20annotation_pages%20%3D%20quote_annotations.select(%0A%20%20%20%20%20%20%20%20pl.col(%22page_index%22%2C%20%22page_text%22%2C%20%22page_start%22%2C%20%22page_end%22)%0A%20%20%20%20).unique()%0A%20%20%20%20return%20(annotation_pages%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(adjust_span_offset%2C%20annotation_pages%2C%20pl%2C%20quotes_adjusted)%3A%0A%20%20%20%20%23%20do%20a%20conditional%20join%20of%20annotation%20pages%20with%20seq2seq%20quotes%20to%20find%20pages%20where%20we%20have%20data%20from%20both%20methods%20for%20comparison%0A%20%20%20%20quotes_pages%20%3D%20quotes_adjusted.join_where(%0A%20%20%20%20%20%20%20%20annotation_pages%2C%0A%20%20%20%20%20%20%20%20pl.col(%22quote_offset_start%22)%20%3E%3D%20pl.col(%22page_start%22)%2C%0A%20%20%20%20%20%20%20%20pl.col(%22quote_offset_start%22)%20%3C%20pl.col(%22page_end%22)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20adjust%20quote%20offset%20to%20make%20them%20relative%20to%20the%20page%20using%20page%20start%0A%20%20%20%20page_offsets%20%3D%20quotes_pages.select(%0A%20%20%20%20%20%20%20%20pl.col(%22quote_offsets_adjusted%22%2C%20%22page_start%22)%0A%20%20%20%20).map_rows(lambda%20row%3A%20adjust_span_offset(row%5B0%5D%2C%20-row%5B1%5D))%0A%0A%20%20%20%20quotes_pages%20%3D%20quotes_pages.with_columns(%0A%20%20%20%20%20%20%20%20quote_offsets_page%3Dpl.Series(page_offsets)%0A%20%20%20%20).sort(%22quote_offset_start%22)%20%20%23%20sort%20by%20order%20in%20the%20file%0A%20%20%20%20return%20(quotes_pages%2C)%0A%0A%0A%40app.cell%0Adef%20_(intspan)%3A%0A%20%20%20%20def%20highlight_spans(text%3A%20str%2C%20spans%3A%20str)%20-%3E%20str%3A%0A%20%20%20%20%20%20%20%20%23%20method%20to%20add%20%3Cmark%3E%20highlighting%20for%20one%20or%20more%20spans%20within%20a%20text%20string%0A%20%20%20%20%20%20%20%20%23%20takes%20text%20and%20string%20with%20one%20or%20more%20spans%20in%20a%20format%20that%20can%20be%20parsed%20by%20intspan%0A%20%20%20%20%20%20%20%20%23%20returns%20the%20text%20with%20%3Cmark%3E%20tags%20around%20the%20highlighted%20regions%0A%20%20%20%20%20%20%20%20spans%20%3D%20intspan(spans)%0A%20%20%20%20%20%20%20%20previous_end%20%3D%200%0A%20%20%20%20%20%20%20%20text_parts%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20for%20start%2C%20end%20in%20spans.ranges()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20text%20before%20the%20mark%0A%20%20%20%20%20%20%20%20%20%20%20%20text_parts.append(text%5Bprevious_end%3Astart%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20text%20to%20be%20highlighted%0A%20%20%20%20%20%20%20%20%20%20%20%20text_parts.append(f%22%3Cmark%3E%7Btext%5Bstart%3Aend%5D%7D%3C%2Fmark%3E%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20set%20previuos%20end%20to%20the%20portion%20after%20this%20span%0A%20%20%20%20%20%20%20%20%20%20%20%20previous_end%20%3D%20end%0A%20%20%20%20%20%20%20%20%23%20append%20any%20text%20after%20the%20last%20highlighted%20portion%0A%20%20%20%20%20%20%20%20text_parts.append(text%5Bprevious_end%3A%5D)%0A%20%20%20%20%20%20%20%20return%20%22%22.join(text_parts)%0A%20%20%20%20return%20(highlight_spans%2C)%0A%0A%0A%40app.cell%0Adef%20_(highlight_spans%2C%20mo%2C%20quote_slider%2C%20quotes_pages)%3A%0A%20%20%20%20def%20display_seq2seq_page(quote)%3A%0A%20%20%20%20%20%20%20%20quote_info%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20field%3A%20quote%5Bfield%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20field%20in%20%5B%22type%22%2C%20%22speaker%22%2C%20%22cue%22%2C%20%22addressee%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20quote%5Bfield%5D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20quote_info_string%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%3Cdl%3E%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%20%22.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%3Cdt%3E%7Bfield%7D%3C%2Fdt%3E%3Cdd%3E%7Bvalue%7D%3C%2Fdd%3E%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20for%20field%2C%20value%20in%20quote_info.items()%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%3C%2Fdl%3E%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20return%20mo.Html(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%3Csection%20class%3D'page'%3E%3Cheader%3E%3Ch1%3Eseq2seq%3C%2Fh2%3E%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%2B%20quote_info_string%0A%20%20%20%20%20%20%20%20%20%20%20%20%2B%20f%22%3Cp%20class%3D'info'%3Epage%20index%20%7Bquote%5B'page_index'%5D%7D%3C%2Fp%3E%3C%2Fheader%3E%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%2B%20highlight_spans(quote%5B%22page_text%22%5D%2C%20quote%5B%22quote_offsets_page%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%2B%20%22%3C%2Fsection%3E%22%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%0A%20%20%20%20def%20current_seq2seq_page()%3A%0A%20%20%20%20%20%20%20%20return%20display_seq2seq_page(%0A%20%20%20%20%20%20%20%20%20%20%20%20quotes_pages.row(quote_slider.value%2C%20named%3DTrue)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20return%20(current_seq2seq_page%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(pl%2C%20quote_annotations)%3A%0A%20%20%20%20%23%20adjust%20annotation%20start%2Fend%20indices%20to%20make%20them%20relative%20to%20the%20page%2C%20then%20convert%20to%20string%20page%20span%20notation%0A%20%20%20%20%23%20then%20group%20annotations%20by%20page%2C%20with%20page%20text%20and%20list%20of%20all%20page%20spans%20for%20annotated%20quotes%20on%20that%20page%0A%0A%20%20%20%20%23%20calculate%20page%20offsets%2C%20then%20turn%20into%20span%0A%20%20%20%20quote_page_spans%20%3D%20(%0A%20%20%20%20%20%20%20%20quote_annotations.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20start_index%3Dpl.col(%22start_index%22).sub(pl.col(%22page_start%22))%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20end_index%3Dpl.col(%22end_index%22).sub(pl.col(%22page_start%22))%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.with_columns(%0A%20%20%20%20%20%20%20%20%20%20%20%20page_span%3Dpl.concat_str(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Bpl.col(%22start_index%22)%2C%20pl.col(%22end_index%22)%5D%2C%20separator%3D%22-%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.select(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22page_index%22%2C%20%22page_span%22%2C%20%22page_text%22)%2C%0A%20%20%20%20%20%20%20%20)%20%20%23%20limit%20to%20just%20page%20index%20and%20quote%20span%20on%20the%20page%0A%20%20%20%20%20%20%20%20.group_by(%22page_index%22)%20%20%23%20group%20by%20pages%0A%20%20%20%20%20%20%20%20.all()%0A%20%20%20%20)%0A%0A%20%20%20%20quote_page_spans%20%3D%20quote_page_spans.with_columns(%0A%20%20%20%20%20%20%20%20page_span%3Dpl.col(%22page_span%22).list.join(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%2C%22%0A%20%20%20%20%20%20%20%20)%2C%20%20%23%20combine%20multiple%20page%20spans%0A%20%20%20%20%20%20%20%20page_text%3Dpl.col(%22page_text%22).list.first()%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(quote_page_spans%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(highlight_spans%2C%20mo%2C%20pl%2C%20quote_page_spans%2C%20quote_slider%2C%20quotes_pages)%3A%0A%20%20%20%20def%20display_annotation_page(annotation_page)%3A%0A%20%20%20%20%20%20%20%20%23%20display%20an%20annotation%20page%20with%20page%20text%20and%20aggregated%20page%20spans%0A%20%20%20%20%20%20%20%20text%20%3D%20highlight_spans(%0A%20%20%20%20%20%20%20%20%20%20%20%20annotation_page%5B%22page_text%22%5D%2C%20annotation_page%5B%22page_span%22%5D%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20return%20mo.Html(f%22%22%22%3Csection%20class%3D'page%20highlight2'%3E%3Cheader%3E%3Ch1%3Eannotations%3C%2Fh2%3E%0A%20%20%20%20%20%20%20%20%3Cp%20class%3D'info'%3Epage%20index%20%7Bannotation_page%5B%22page_index%22%5D%7D%3C%2Fp%3E%3C%2Fheader%3E%0A%20%20%20%20%20%20%20%20%7Btext%7D%0A%20%20%20%20%20%20%20%20%3C%2Fsection%3E%22%22%22)%0A%0A%0A%20%20%20%20def%20current_selected_annotation()%3A%0A%20%20%20%20%20%20%20%20%23%20display%20the%20annotation%20page%20based%20on%20current%20slider%20selection%0A%20%20%20%20%20%20%20%20%23%20get%20page%20index%20from%20quote%20pages%20row%0A%20%20%20%20%20%20%20%20page_index%20%3D%20quotes_pages.row(quote_slider.value%2C%20named%3DTrue)%5B%22page_index%22%5D%0A%20%20%20%20%20%20%20%20%23%20get%20annotation%20page%20by%20page%20index%20with%20text%20and%20spans%20as%20dict%0A%20%20%20%20%20%20%20%20annotation_page%20%3D%20quote_page_spans.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22page_index%22).eq(page_index)%0A%20%20%20%20%20%20%20%20).row(0%2C%20named%3DTrue)%0A%0A%20%20%20%20%20%20%20%20return%20display_annotation_page(annotation_page)%0A%20%20%20%20return%20(current_selected_annotation%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(pl%2C%20quote_page_spans)%3A%0A%20%20%20%20import%20re%0A%20%20%20%20%23%20generate%20heuristic%20search%20results%20for%20the%20pages%20in%20range%0A%0A%0A%20%20%20%20%23%20adapted%20from%20find_quotes%20method%20in%20find-quotes%20notebook%0A%20%20%20%20def%20find_quotes_spans(text)%3A%0A%20%20%20%20%20%20%20%20spans%20%3D%20%5B%5D%0A%20%20%20%20%20%20%20%20%23%20Find%20basic%20quotes%20of%20the%20form%20%E2%80%9E%20...%20%E2%80%9C%20or%20%E2%80%9E%20...%20%22%0A%20%20%20%20%20%20%20%20for%20match%20in%20re.finditer(r%22%E2%80%9E%5B%5E%E2%80%9C%5C%22%5D%2B%5B%E2%80%9C%5C%22%5D%22%2C%20text)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20start%2C%20end%20%3D%20match.span()%0A%20%20%20%20%20%20%20%20%20%20%20%20spans.append(f%22%7Bstart%7D-%7Bend%7D%22)%0A%20%20%20%20%20%20%20%20return%20%22%2C%22.join(spans)%0A%0A%0A%20%20%20%20heuristic_quote_spans%20%3D%20quote_page_spans.select(%0A%20%20%20%20%20%20%20%20pl.col(%22page_index%22%2C%20%22page_text%22)%0A%20%20%20%20).with_columns(%0A%20%20%20%20%20%20%20%20heuristic_spans%3Dpl.col(%22page_text%22).map_elements(%0A%20%20%20%20%20%20%20%20%20%20%20%20find_quotes_spans%2C%20return_dtype%3Dpl.String%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20)%0A%20%20%20%20return%20(heuristic_quote_spans%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(%0A%20%20%20%20heuristic_quote_spans%2C%0A%20%20%20%20highlight_spans%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20pl%2C%0A%20%20%20%20quote_slider%2C%0A%20%20%20%20quotes_pages%2C%0A)%3A%0A%20%20%20%20def%20display_heuristic_quotes_page(annotation_page)%3A%0A%20%20%20%20%20%20%20%20text%20%3D%20highlight_spans(%0A%20%20%20%20%20%20%20%20%20%20%20%20annotation_page%5B%22page_text%22%5D%2C%20annotation_page%5B%22heuristic_spans%22%5D%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20return%20mo.Html(f%22%22%22%3Csection%20class%3D'page%20highlight3'%3E%3Cheader%3E%3Ch1%3Equotation%20marks%3C%2Fh1%3E%0A%20%20%20%20%20%20%20%20%3Cp%20class%3D'info'%3Epage%20index%20%7Bannotation_page%5B%22page_index%22%5D%7D%3C%2Fp%3E%3C%2Fheader%3E%0A%20%20%20%20%20%20%20%20%7Btext%7D%0A%20%20%20%20%20%20%20%20%3C%2Fsection%3E%22%22%22)%0A%0A%0A%20%20%20%20def%20current_page_heuristic_quotes()%3A%0A%20%20%20%20%20%20%20%20%23%20get%20page%20index%20from%20quote%20pages%20row%0A%20%20%20%20%20%20%20%20page_index%20%3D%20quotes_pages.row(quote_slider.value%2C%20named%3DTrue)%5B%22page_index%22%5D%0A%20%20%20%20%20%20%20%20%23%20get%20annotation%20page%20by%20page%20index%20with%20text%20and%20spans%20as%20dict%0A%20%20%20%20%20%20%20%20page%20%3D%20heuristic_quote_spans.filter(%0A%20%20%20%20%20%20%20%20%20%20%20%20pl.col(%22page_index%22).eq(page_index)%0A%20%20%20%20%20%20%20%20).row(0%2C%20named%3DTrue)%0A%0A%20%20%20%20%20%20%20%20return%20display_heuristic_quotes_page(page)%0A%20%20%20%20return%20(current_page_heuristic_quotes%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20show_annotations%20%3D%20mo.ui.switch(label%3D%22annotations%22%2C%20value%3DTrue)%0A%20%20%20%20show_heuristic%20%3D%20mo.ui.switch(label%3D%22quotation%20marks%22%2C%20value%3DTrue)%0A%20%20%20%20switch_stack%20%3D%20mo.hstack(%5Bshow_annotations%2C%20show_heuristic%5D%2C%20justify%3D%22start%22)%0A%20%20%20%20return%20show_annotations%2C%20show_heuristic%2C%20switch_stack%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Quotes%20detected%20by%20seq2seq-quotation-attribution%20include%20the%20type%20of%20quote%20(direct%2C%20indirect)%2C%20and%20may%20include%20additional%20information%20such%20as%20speaker%2C%20addressee%2C%20and%20cue.%20%0A%0A%20%20%20%20This%20view%20provides%20detected%20information%20about%20a%20single%20quote%20with%20that%20quote%20in%20context%20on%20a%20page%20of%20text.%20%20In%20many%20cases%2C%20multiple%20quotations%20are%20detected%20for%20each%20page%3B%20these%20are%20displayed%20one%20at%20a%20time.%0A%0A%20%20%20%20For%20comparison%2C%20seq2seq%20results%20can%20be%20viewed%20alongside%20the%20same%20page%20of%20text%20with%20all%20manual%20annotations%20for%20that%20page%20and%2For%20all%20quotes%20found%20based%20on%20quotation%20marks.%20%20Use%20the%20toggles%20to%20control%20which%20versions%20of%20the%20page%20are%20shown.%0A%0A%20%20%20%20Use%20the%20slider%20to%20move%20through%20this%20subset%20of%20seq2seq%20results.%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo%2C%20quotes_pages%2C%20switch_stack)%3A%0A%20%20%20%20quote_slider%20%3D%20mo.ui.slider(%0A%20%20%20%20%20%20%20%20start%3D0%2C%0A%20%20%20%20%20%20%20%20stop%3Dquotes_pages.height%20-%201%2C%0A%20%20%20%20%20%20%20%20step%3D1%2C%0A%20%20%20%20%20%20%20%20label%3D%22seq2seq%20quote%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20mo.vstack(%5Bquote_slider%2C%20switch_stack%5D)%0A%20%20%20%20return%20(quote_slider%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(%0A%20%20%20%20current_page_heuristic_quotes%2C%0A%20%20%20%20current_selected_annotation%2C%0A%20%20%20%20current_seq2seq_page%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20show_annotations%2C%0A%20%20%20%20show_heuristic%2C%0A)%3A%0A%20%20%20%20%23%20always%20show%20seq2seq%0A%20%20%20%20panels%20%3D%20%5Bcurrent_seq2seq_page()%5D%0A%20%20%20%20if%20show_annotations.value%3A%0A%20%20%20%20%20%20%20%20panels.append(current_selected_annotation())%0A%20%20%20%20if%20show_heuristic.value%3A%0A%20%20%20%20%20%20%20%20panels.append(current_page_heuristic_quotes())%0A%0A%20%20%20%20mo.hstack(panels%2C%20justify%3D%22center%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20%23%20todo%3A%20can%20we%20do%20an%20overlap%20view%20of%20the%20same%20content%20as%20above%3F%20(maybe%20only%20two%20at%20a%20time...)%0A%20%20%20%20%23%20configure%20highlight%20colors%20above%20and%20below%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20---%0A%0A%20%20%20%20%23%23%20seq2seq-quotation-attribution%20raw%20output%0A%0A%20%20%20%20In%20case%20it's%20useful%2C%20the%20table%20below%20shows%20the%20quotes%20data%20as%20output%20by%20seq2seq%20quotation%20detection.%0A%0A%20%20%20%20(The%20tool%20was%20run%20on%20chunked%20sections%20of%20the%20original%20file%20due%20to%20memory%20limitations%3B%20offsets%20were%20remapped%20to%20the%20original%20file%20for%20comparison%20and%20display.)%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20quotes_df)%3A%0A%20%20%20%20mo.ui.table(%0A%20%20%20%20%20%20%20%20quotes_df%2C%0A%20%20%20%20%20%20%20%20page_size%3D15%2C%0A%20%20%20%20%20%20%20%20selection%3DNone%2C%0A%20%20%20%20%20%20%20%20label%3D%22seq2seq%20quotes%20data%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
  </body>
</html>
